---
layout: single
title: "**️커스텀 애노테이션과 AOP를 활용한 권한 검사 구현하기**"
excerpt: ""
---

## 리팩토링 전 코드

주문과 배달 관련 API에서 사용자 토큰을 통해 접근 권한을 확인하는 로직이 중복되는 문제가 발생하였습니다. 이외에도 주문 상태 변경과 배달 상태 변경 로직에서도 아래와 같이 사용자의 권한을 확인하는 부분이 반복되었습니다.

```java
@Transactional
    public Order createOrder(JwtAuthentication jwtAuthentication, OrderRequest orderRequest) {
        if (!jwtAuthentication.getRole().equals(Role.CLIENT)) {
            throw new AccessDeniedException("고객만 주문할 수 있습니다.");
        }
    ...
}
```

```java
@Transactional
    public Delivery assignDelivery(Long orderId, Long riderId, JwtAuthentication jwtAuthentication) {
        if (!jwtAuthentication.getRole().equals(Role.RIDER)) {
            throw new AccessDeniedException("배달원만 배달을 할 수 있습니다.");
        }
    ...
}
```

예를 들어, 고객이 주문을 완료한 후 사장님이 배달을 수락하거나 배달 상태를 변경할 때에는 사장님 권한으로 로그인이 되어있어야 합니다. 이러한 불필요한 코드 반복을 줄이고 핵심 비즈니스 로직과 권한 확인 로직을 분리하여 관리하는 것이 더 좋은 방식이라고 생각했습니다.

## AOP란 무엇일까?

**AOP는 애플리케이션의 공통 관심 사항을 모듈화하는 방법입니다.** 이는 코드의 중복을 줄이고, 유지 보수를 용이하게 만듭니다. 소프트웨어 개발 과정에서 로깅, 보안, 트랜잭션 관리와 같은 기능은 여러 모듈이나 함수에서 공통적으로 필요하지만 이렇게 분산된 공통 기능을 효율적으로 관리하는 것은 어렵기 때문입니다.

AOP는 이러한 공통 관심 사항을 별도의 'Aspect'로 분리하여 관리함으로써, 비즈니스 로직의 코드를 깔끔하게 유지할 수 있도록 도와줍니다. 특히, 스프링 프레임워크에서는 AOP를 지원하여 개발자들이 손쉽게 이 패러다임을 적용할 수 있도록 도와줍니다. 스프링 AOP를 통해 개발자는 실행 시점에 동적으로 Aspect를 적용할 수 있습니다.

또한, 스프링 AOP는 프록시 객체를 사용하여 구현됩니다. 프록시 객체는 다른 객체를 대신해 대리 역할을 수행하는 객체를 말합니다. 스프링의 AOP는 다음과 같이 동작합니다.


- 스프링은 애플리케이션에서 관리하는 모든 빈(Bean)을 조사하여, AOP 관련 설정(예: Aspect, Pointcut)을 확인합니다.
- 만약 특정 빈에 대해 부가 기능을 적용해야 한다고 판단되면, 스프링은 해당 빈의 프록시 객체를 생성합니다. 프록시 객체는 클라이언트가 원래 빈을 호출하는 것처럼 보이도록, 동일한 인터페이스를 구현하거나 상속받아 생성됩니다.
- 프록시 객체는 클라이언트가 메소드를 호출할 때마다 포인트컷을 사용해 해당 메소드가 부가 기능의 대상인지 확인합니다.
- 포인트컷 조건을 만족하는 경우, 프록시 객체는 지정된 부가 기능(Advice)을 실행합니다.

여기서  'Aspect', 'Join point', 'Advice', 'Pointcut', 'Weaving'과 같은 주요 개념이 있습니다.

- **Aspect** : 공통 관심 사항을 모듈화한 것으로 로깅이나 보안 등의 기능을 Aspect로 정의할 수 있습니다. **Aspect는 Pointcut과 Advice를 포함**하여, 어떤 시점에 어떤 부가 기능을 적용할지를 정의합니다.
- **Join Point** : **Aspect가 적용될 수 있는 위치**, 즉 메소드 호출이나 필드 접근과 같은 프로그램 실행의 특정 지점을 의미합니다.
- **Advice** : Join point에서 **실행될 공통 기능의 코드**입니다. 동작 시점엔 'Before', 'After', 'Around'와 같은 다양한 유형이 있습니다. 
- **Pointcut** : **Join point를 정의하는 표현식**으로, 실제로 Advice가 적용될 위치를 결정합니다.
- **Target** : **Advice가 적용되는 대상 객체**를 의미합니다.
- **Weaving** : **Pointcut에 명시된 Join point에 Advice를 적용하는 과정**을 의미합니다.

## Role enum

현재 사용자 권한은 CLIENT, ADMIN, OWNER, RIDER로 나뉘어져 있습니다.

```java
public enum Role {
    CLIENT, ADMIN, OWNER, RIDER
}
```

## CheckRole 애노테이션 설정

우선, AOP를 사용하기 위해서는 부가 기능인 어드바이스(Advice)를 적용할 수 있는 지점인 포인트컷(Pointcut)과 실제 부가 기능을 담고있는 어드바이스(Advice)가 필요합니다.


